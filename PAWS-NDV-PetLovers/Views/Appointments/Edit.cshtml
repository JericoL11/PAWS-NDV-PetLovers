@model PAWS_NDV_PetLovers.Models.Appointments.Appointment
@{
    ViewData["Title"] = "Edit";
}

<div class="bg-secondary bg-opacity-10 py-2 mb-3">
    <div class="container">
        <h1>Update Appointment</h1>
    </div>    
</div>

<div class="container">
    <form asp-action="Edit" method="post">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input asp-for="AppointId" hidden/>
        <div class="row">
            @* appointments *@
            <div class="form-group col-lg-4">
                <label asp-for="fname" class="control-label"></label>
                <input asp-for="fname" class="form-control" />
                <span asp-validation-for="fname" class="text-danger"></span>
            </div>

            <div class="form-group col-lg-4">
                <label asp-for="lname" class="control-label"></label>
                <input asp-for="lname" class="form-control" />
                <span asp-validation-for="lname" class="text-danger"></span>
            </div>

            <div class="form-group col-lg-4">
                <label asp-for="mname" class="control-label"></label>
                <input asp-for="mname" class="form-control" />
                <span asp-validation-for="mname" class="text-danger"></span>
            </div>

            <div class="form-group col-lg-4">
                <label asp-for="contact" class="control-label"></label>
                <input id="contact" asp-for="contact" class="form-control" />
                <span asp-validation-for="contact" class="text-danger"></span>
            </div>

            <div class="form-group col-lg-4">
                <label asp-for="date" class="control-label"></label>
                <input asp-for="date" class="form-control minDate" id="appointmentDate" type="date" />
                <span asp-validation-for="date" class="text-danger"></span>
            </div>

            <div class="form-group col-lg-4">
                <label asp-for="time" class="control-label"></label>
                <select id="timeDropdown" name="time" class="form-control" required>
                    <!-- Times will be loaded here -->
                </select>
                <span asp-validation-for="time" class="text-danger"></span>
            </div>

            <div class="form-group col-lg-4">
                @{
                    var services = Model.IAppDetails
                    .Select(ad => ad.Services)
                    .Distinct()
                    .ToList();

                }
                 <label class="control-label">Services</label>
                    @foreach (var service in services)
                    {
                        <input class="form-control mt-2" value="@service.serviceName" disabled />
                    }
              
            </div>
            <div class="form-group">
                <a class="btn btn-secondary" asp-action="Index">Cancel</a>
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
       </form>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
         
            function fetchAvailableTimes() {
                var selectedDate = $('#appointmentDate').val();

                if (selectedDate) {
                    $.ajax({
                        url: '@Url.Action("GetAvailableTimes", "Appointments")',
                        type: 'GET',
                        data: { date: selectedDate },
                        success: function (data) {
                            var timeDropdown = $('#timeDropdown');
                            timeDropdown.empty(); // Clear existing options

                            var hasAvailableTimes = false;

                            // Add AM options
                            if (data.availableAM && data.availableAM.length > 0) {
                                var amGroup = $('<optgroup>', { label: 'Morning' });
                                $.each(data.availableAM, function (index, value) {
                                    amGroup.append($('<option>', {
                                        value: value,
                                        text: value + ' am'
                                    }));
                                });
                                timeDropdown.append(amGroup);
                                hasAvailableTimes = true;
                            }

                            // Add PM options
                            if (data.availablePM && data.availablePM.length > 0) {
                                var pmGroup = $('<optgroup>', { label: 'Afternoon' });
                                $.each(data.availablePM, function (index, value) {
                                    pmGroup.append($('<option>', {
                                        value: value,
                                        text: value
                                    }));
                                });
                                timeDropdown.append(pmGroup);
                                hasAvailableTimes = true;
                            }

                            // If no available times, add "Fully booked" option
                            if (!hasAvailableTimes) {
                                timeDropdown.append($('<option>', {
                                    value: '',
                                    text: 'Fully booked',
                                    disabled: true,
                                    selected: true
                                }));
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching available times:', error);
                        }
                    });
                }
            }


            // Trigger the date change event on page load if date is pre-filled
            if ($('#appointmentDate').val()) {
                fetchAvailableTimes();
            }

            $('#appointmentDate').change(fetchAvailableTimes);
        });
    </script>

}
